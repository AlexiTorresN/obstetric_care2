name: SonarCloud Analysis

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    
    steps:
    # Checkout del código
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    # Configurar Python
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # Instalar dependencias del sistema para MySQL
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev default-libmysqlclient-dev build-essential
        sudo apt-get install -y pkg-config
    
    # Cache de dependencias pip
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    # Instalar dependencias Python
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel
        pip install cryptography
        pip install pymysql
        pip install coverage pytest pytest-django pytest-cov
        pip install -r requirements.txt || true
    
    # Crear settings de prueba
    - name: Create test settings
      run: |
        cat > test_settings.py << 'EOF'
        from pathlib import Path
        import os

        BASE_DIR = Path(__file__).resolve().parent
        SECRET_KEY = 'test-secret-key-for-github-actions'
        DEBUG = False
        ALLOWED_HOSTS = ['*']

        INSTALLED_APPS = [
            'django.contrib.admin',
            'django.contrib.auth',
            'django.contrib.contenttypes',
            'django.contrib.sessions',
            'django.contrib.messages',
            'django.contrib.staticfiles',
            'gestionApp',
            'matronaApp',
            'medicoApp',
            'tensApp',
            'partosApp',
            'ingresoPartoApp',
            'recienNacidoApp',
        ]

        MIDDLEWARE = [
            'django.middleware.security.SecurityMiddleware',
            'django.contrib.sessions.middleware.SessionMiddleware',
            'django.middleware.common.CommonMiddleware',
            'django.middleware.csrf.CsrfViewMiddleware',
            'django.contrib.auth.middleware.AuthenticationMiddleware',
            'django.contrib.messages.middleware.MessageMiddleware',
            'django.middleware.clickjacking.XFrameOptionsMiddleware',
        ]

        ROOT_URLCONF = 'obstetric_care.urls'
        
        TEMPLATES = [
            {
                'BACKEND': 'django.template.backends.django.DjangoTemplates',
                'DIRS': [],
                'APP_DIRS': True,
                'OPTIONS': {
                    'context_processors': [
                        'django.template.context_processors.debug',
                        'django.template.context_processors.request',
                        'django.contrib.auth.context_processors.auth',
                        'django.contrib.messages.context_processors.messages',
                    ],
                },
            },
        ]

        # Base de datos SQLite para tests
        DATABASES = {
            'default': {
                'ENGINE': 'django.db.backends.sqlite3',
                'NAME': BASE_DIR / 'test_db.sqlite3',
            }
        }

        # Configuración simplificada para tests
        LANGUAGE_CODE = 'es-cl'
        TIME_ZONE = 'UTC'
        USE_I18N = True
        USE_TZ = True
        STATIC_URL = '/static/'
        DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
        
        # Desactivar validadores de contraseña para tests
        AUTH_PASSWORD_VALIDATORS = []
        EOF
    
    # Ejecutar tests con SQLite (sin MySQL)
    - name: Run tests with coverage
      env:
        DJANGO_SETTINGS_MODULE: test_settings
        PYTHONPATH: ${{ github.workspace }}
      run: |
        # Crear migraciones si es necesario
        python manage.py migrate --run-syncdb --noinput --settings=test_settings || true
        
        # Crear archivo de coverage vacío si no hay tests
        echo '<?xml version="1.0" ?><coverage version="1.0"><packages></packages></coverage>' > coverage.xml
        
        # Intentar ejecutar tests si existen
        python manage.py test --settings=test_settings --verbosity=2 || true
        
        # Si hay archivos de test, ejecutar coverage
        if [ -d "gestionApp/tests" ] || [ -d "tests" ]; then
          coverage run --source='.' manage.py test --settings=test_settings || true
          coverage xml || true
        fi
    
    # Análisis de seguridad con Bandit
    - name: Run Bandit Security Analysis
      continue-on-error: true
      run: |
        pip install bandit
        bandit -r . -f json -o bandit.json --skip B101,B601,B301,B303 || true
    
    # SonarCloud Scan
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      continue-on-error: true     # <--- ESTA LÍNEA PERMITE QUE EL PIPELINE SIGA AUNQUE FALLE SONARQUBE, SE PUEDE QUITAR SI SE DESEA QUE EL ANALISIS SEA OBLIGATORIO
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=alexi_obstetric_care2
          -Dsonar.organization=alexitorresn
          -Dsonar.python.coverage.reportPaths=coverage.xml